<!DOCTYPE HTML>
<html lang="zh-CN">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0,maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="renderer" content="webkit">
    <meta http-equiv="Cache-Control" content="no-siteapp">
    <title>WaterMark</title>
    <link href="https://cdn.staticfile.org/mdui/1.0.2/css/mdui.min.css" rel="stylesheet">
    <link href="./photomark.css" rel="stylesheet">
    <script src="https://cdn.staticfile.org/mdui/1.0.2/js/mdui.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/exifr/dist/full.umd.js"></script>
    <script src="./logo.js"></script>
    <script>
        var $ = mdui.$;
        var langLib;
        var langType = window.navigator.language.toLowerCase();

        $.ajax({
            url: `./${langType}.json`,
            async: false,
            dataType: 'json',
            success: res => {
                langLib = res;
            },
            error: () => {
                $.ajax({
                    url: './en-us.json',
                    async: false,
                    dataType: 'json',
                    success: res => {
                        langLib = res;
                    }
                });
                mdui.snackbar({
                    message: 'Failed to load localization data',
                    position: 'right-top'
                });
            }
        });

        function getI18n(item) {
            var i18nItem = null;
            if (typeof langLib[item] != 'undefined') {
                i18nItem = langLib[item];
            }
            return i18nItem;
        }
    </script>
</head>

<body>
    <div class="mdui-container">
        <div id="main-flex" class="mdui-row-xs-1 mdui-row-sm-2">
            <div id="photo-col" class="mdui-col">
                <!-- ÁÖßÁâá‰∏ä‰º†ÂâçÁöÑÂÆπÂô® -->
                <div id="photo-area" class="mdui-color-grey-200 mdui-ripple mdui-img-rounded mdui-valign"
                    style="height: 256px; background-size: contain; background-repeat: no-repeat; background-position: center;"
                    onclick="chooseFile()">
                    <div class="mdui-center" style="text-align: center;">
                        <div id="photo-tip">
                            <i class="mdui-icon material-icons" style="font-size: 64px; opacity: .5;">camera_alt</i>
                            <h1>
                                <script>document.write(getI18n('drag_your_photo_to_here'))</script>
                            </h1>
                            <p>
                                <script>document.write(getI18n('or_click_here_to_choose_a_file'))</script>
                            </p>
                        </div>
                        <p id="photo-info" class="mdui-hidden">Unknown</p>
                    </div>
                </div>
                <!-- ÁÖßÁâá‰∏ä‰º†ÂêéÁöÑÂÆπÂô® -->
                <div id="photo-container" class="mdui-hidden">
                    <div id="photo-canvas-div" class="mdui-ripple mdui-hidden" style="padding: 4px;">
                        <canvas id="photo-canvas" class="mdui-hidden"></canvas>
                        <img id="photo-preview" class="mdui-img-rounded mdui-shadow-3" onclick="chooseFile()">
                    </div>
                </div>
            </div>
            <div id="info-col" class="mdui-col">
                <div class="mdui-row-xs-2">
                    <div class="mdui-col">
                        <div class="mdui-textfield">
                            <label class="mdui-textfield-label">
                                <script>document.write(getI18n('logo_type'))</script>
                            </label>
                            <select id="logo-select" class="mdui-select mdui-textfield-input">
                                <option value="none">
                                    <script>document.write(getI18n('none'))</script>
                                </option>
                                <option value="sony">
                                    <script>document.write(getI18n('sony'))</script>
                                </option>
                                <option value="canon">
                                    <script>document.write(getI18n('canon'))</script>
                                </option>
                                <option value="hasselblad">
                                    <script>document.write(getI18n('hasselbled'))</script>
                                </option>
                                <option value="leica">
                                    <script>document.write(getI18n('leica'))</script>
                                </option>
                                <option value="nikon">
                                    <script>document.write(getI18n('nikon'))</script>
                                </option>
                                <option value="oneplus">
                                    <script>document.write(getI18n('oneplus'))</script>
                                </option>
                                <option value="xiaomi">
                                    <script>document.write(getI18n('xiaomi'))</script>
                                </option>
                                <option value="zeiss">
                                    <script>document.write(getI18n('zeiss'))</script>
                                </option>
                            </select>
                        </div>
                    </div>
                    <div class="mdui-col">
                        <div class="mdui-textfield">
                            <label class="mdui-textfield-label">
                                <script>document.write(getI18n('fonts'))</script>
                            </label>
                            <select id="font-select" class="mdui-select mdui-textfield-input">
                                <option class="mi-sans" value="1">MiSans</option>
                                <option class="harmony-sans" value="2">HarmonyOS Sans</option>
                                <option class="oppo-sans" value="3">OPPOSans</option>
                                <option class="sf-pro" value="4">SF Pro Display</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="mdui-row-xs-2">
                    <div class="mdui-col">
                        <div class="mdui-textfield">
                            <label class="mdui-textfield-label">
                                <script>document.write(getI18n('image_scale'))</script>
                            </label>
                            <select id="zoom-select" class="mdui-select mdui-textfield-input">
                                <option value="0.5">0.5x</option>
                                <option value="0.75">0.75x</option>
                                <option value="1" selected>
                                    <script>document.write(getI18n('original_size'))</script>
                                </option>
                                <option value="1.25">1.25x</option>
                                <option value="1.5">1.5x</option>
                                <option value="2">2x</option>
                            </select>
                        </div>
                    </div>
                    <div class="mdui-col">
                        <div class="mdui-textfield">
                            <label class="mdui-textfield-label">
                                <script>document.write(getI18n('export_quality'))</script>
                            </label>
                            <div style="display: flex; align-items: center;">
                                <div class="mdui-slider" id="quality-slider" style="flex: 1; margin-right: 10px;">
                                    <input type="range" min="25" max="100" value="100" step="1" />
                                </div>
                                <div id="quality-value" style="min-width: 40px; text-align: right;">
                                    <script>document.write(getI18n('yuantu'))</script>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="mdui-textfield mdui-textfield-floating-label">
                    <label class="mdui-textfield-label">
                        <script>document.write(getI18n('device_name'))</script>
                    </label>
                    <input id="device-input" class="mdui-textfield-input" type="text" disabled />
                </div>
                <div class="mdui-textfield mdui-textfield-floating-label">
                    <label class="mdui-textfield-label">
                        <script>document.write(getI18n('time'))</script>
                    </label>
                    <input id="time-input" class="mdui-textfield-input" type="text" disabled />
                </div>
                <div class="mdui-textfield mdui-textfield-floating-label">
                    <label class="mdui-textfield-label">
                        <script>document.write(getI18n('lens_info'))</script>
                    </label>
                    <input id="lens-input" class="mdui-textfield-input" type="text" disabled />
                </div>
                <div class="mdui-textfield mdui-textfield-floating-label">
                    <label class="mdui-textfield-label">
                        <script>document.write(getI18n('location'))</script>
                    </label>
                    <input id="location-input" class="mdui-textfield-input" type="text" disabled />
                </div>
                <div class="mdui-typo">
                    <a onclick="getLocation()" style="cursor: pointer;">
                        <script>document.write(getI18n('use_current_location'))</script>
                    </a> | <a onclick="matchModel()" style="cursor: pointer;">
                        <script>document.write(getI18n('match_model'))</script>
                    </a>
                </div>
                <br />
                <div class="mdui-float-right">
                    <button id="preview-btn" class="mdui-btn mdui-ripple mdui-hidden" onclick="drawImage(true)"
                        disabled>
                        <script>document.write(getI18n('preview'))</script>
                    </button>
                    <button id="save-btn" class="mdui-btn mdui-btn-raised mdui-ripple mdui-color-pink"
                        onclick="drawImage()" disabled>
                        <script>document.write(getI18n('save'))</script>
                    </button>
                </div>
                <br /><br /><br /><br />
                <div class="mdui-typo" style="opacity: .8;">
                    <p style="margin: 0;">
                        <script>document.write(getI18n('not_for_commercial_use'))</script>
                    </p>
                    <p style="margin: 0;">üòÜMade by yuange |
                        <!-- <a onclick="getContributors()" style="cursor: pointer;">
                            <script>document.write(getI18n('contributors'))</script>
                        </a> |  -->
                        <a onclick="getFAQ()" style="cursor: pointer;">
                            <script>document.write(getI18n('faq'))</script>
                        </a> | <a href="https://profile.yuange.us.kg" target="_blank" style="cursor: pointer;">
                            Home
                        </a>
                    </p>
                </div>
                <br />
                <div class="mdui-float-right">
                    <button id="theme-toggle" class="mdui-btn mdui-btn-icon mdui-ripple">
                        <i class="mdui-icon material-icons">brightness_4</i>
                    </button>
                </div>
            </div>
        </div>
    </div>
    <script>
        var $ = mdui.$;
        var photoFile;
        var photoCanvas = document.querySelector('#photo-canvas');
        var photoCtx = photoCanvas.getContext('2d');
        var photoExif;

        const fontList = [null, 'MiSans', 'HarmonyOS Sans', 'OPPOSans', 'SF Pro Display'];

        Date.prototype.format = function (fmt) {
            var o = {
                "M+": this.getMonth() + 1,
                "d+": this.getDate(),
                "h+": this.getHours(),
                "m+": this.getMinutes(),
                "s+": this.getSeconds(),
                "q+": Math.floor((this.getMonth() + 3) / 3),
                "S": this.getMilliseconds()
            };
            if (/(y+)/.test(fmt)) {
                fmt = fmt.replace(RegExp.$1, (this.getFullYear() + "").substr(4 - RegExp.$1.length));
            }
            for (var k in o) {
                if (new RegExp("(" + k + ")").test(fmt)) {
                    fmt = fmt.replace(RegExp.$1, (RegExp.$1.length == 1) ? (o[k]) : (("00" + o[k]).substr(("" + o[k]).length)));
                }
            }
            return fmt;
        }

        function changeToDFM(du) {
            du = String(du);
            const arr1 = du.split(".");
            const d = arr1[0];
            let tp = "0." + arr1[1]
            tp = String(tp * 60); // ËøõË°åÂº∫Âà∂Á±ªÂûãËΩ¨Êç¢
            const arr2 = tp.split(".");
            const f = arr2[0];
            tp = "0." + arr2[1];
            tp = tp * 60;
            const m = tp.toFixed(0); // ‰øùÁïô‰∏§‰ΩçÂ∞èÊï∞
            const dfm = d + "¬∞" + f + "'" + m + "\"";
            return dfm;
        }

        function chooseFile() {
            // ÂàõÂª∫‰∏Ä‰∏™ input ÂÖÉÁ¥†ÔºåÁî®‰∫éÈÄâÊã©Êñá‰ª∂
            var fileInput = document.createElement('input');
            // ËÆæÁΩÆ input ÂÖÉÁ¥†ÁöÑÁ±ªÂûã‰∏∫ file
            fileInput.type = 'file';
            // ËÆæÁΩÆ input ÂÖÉÁ¥†Êé•ÂèóÁöÑÊñá‰ª∂Á±ªÂûã‰∏∫ image
            fileInput.accept = 'image/*';
            // Ê®°ÊãüÁÇπÂáª input ÂÖÉÁ¥†ÔºåÂºπÂá∫Êñá‰ª∂ÈÄâÊã©Ê°Ü
            fileInput.click();
            // Á¶ÅÁî®ËÆæÂ§áÂêçÁß∞ËæìÂÖ•Ê°Ü
            $('#device-input').prop('disabled', true);
            // Á¶ÅÁî®Êó∂Èó¥ËæìÂÖ•Ê°Ü
            $('#time-input').prop('disabled', true);
            // Á¶ÅÁî®ÈïúÂ§¥‰ø°ÊÅØËæìÂÖ•Ê°Ü
            $('#lens-input').prop('disabled', true);
            // Á¶ÅÁî®‰ΩçÁΩÆ‰ø°ÊÅØËæìÂÖ•Ê°Ü
            $('#location-input').prop('disabled', true);

            // ÂΩìÊñá‰ª∂ÈÄâÊã©ÂèëÁîüÂèòÂåñÊó∂
            fileInput.onchange = (e) => {
                console.log("fileInput.onchange", e);
                // Âà§Êñ≠ÊòØÂê¶ÊòØ Safari ÊµèËßàÂô®
                if (navigator.userAgent.indexOf('Safari/') > -1) {
                    // Â¶ÇÊûúÊòØ Safari ÊµèËßàÂô®ÔºåÂàôËØªÂèñÈÄâÊã©ÁöÑÊñá‰ª∂
                    readImage(e.target.files[0]);
                } else {
                    // Â¶ÇÊûú‰∏çÊòØ Safari ÊµèËßàÂô®ÔºåÂàôËØªÂèñÈÄâÊã©ÁöÑÊñá‰ª∂
                    readImage(e.path[0].files[0]);
                }
            }
        }

        function readImage(file) {
            // Â∞ÜÈÄâÊã©ÁöÑÊñá‰ª∂ËµãÂÄºÁªô photoFile ÂèòÈáè
            photoFile = file;
            console.log("photoFile", photoFile);
            // Âà§Êñ≠ÈÄâÊã©ÁöÑÊñá‰ª∂ÊòØÂê¶‰∏∫ÂõæÁâáÁ±ªÂûã
            if (photoFile.type.indexOf('image') == -1) {
                // Â¶ÇÊûú‰∏çÊòØÂõæÁâáÁ±ªÂûãÔºåÂºπÂá∫ÊèêÁ§∫
                mdui.snackbar({
                    message: getI18n('please_select_a_image_file'),
                    position: 'right-top'
                });
                return;
            }

            // ÈöêËóèÁÖßÁâáÊèêÁ§∫‰ø°ÊÅØ
            $('#photo-tip').addClass('mdui-hidden');
            // ÊòæÁ§∫Âä†ËΩΩ‰∏≠ÊèêÁ§∫
            $('#photo-info').text(getI18n('loading'));
            $('#photo-info').removeClass('mdui-hidden');

            // ÂàõÂª∫ FileReader ÂØπË±°Áî®‰∫éËØªÂèñÊñá‰ª∂
            var reader = new FileReader();
            // Êñá‰ª∂ËØªÂèñÂÆåÊàêÂêéÊâßË°å
            reader.onload = (e) => {
                console.log("reader.onload", e);
                // ÂàõÂª∫ Image ÂØπË±°Áî®‰∫éËé∑ÂèñÂõæÁâá‰ø°ÊÅØ
                var photoImage = new Image();
                photoImage.src = e.target.result;
                // ÂõæÁâáÂä†ËΩΩÂÆåÊàêÂêéÊâßË°å
                photoImage.onload = () => {
                    // ÊòæÁ§∫ÂõæÁâáÊñá‰ª∂ÂêçÂíåÂÆΩÈ´ò‰ø°ÊÅØ
                    $('#photo-info').html(`${photoFile.name}<br />${photoImage.width}x${photoImage.height}`);

                    // ÂàùÂßãÂåñËÆæÂ§á„ÄÅÊó∂Èó¥„ÄÅÈïúÂ§¥Âíå‰ΩçÁΩÆ‰ø°ÊÅØ‰∏∫ Unknown
                    $('#device-input').val('Unknown');
                    $('#time-input').val('Unknown');
                    $('#lens-input').val('Unknown');
                    $('#location-input').val('Unknown');

                    // ‰ΩøÁî® exifr Ëß£ÊûêÂõæÁâá EXIF ‰ø°ÊÅØ
                    exifr.parse(e.target.result).then(res => {
                        console.log(res);
                        // Â∞Ü EXIF ‰ø°ÊÅØ‰øùÂ≠òÂà∞ photoExif ÂèòÈáè
                        photoExif = res;
                        // Â¶ÇÊûú EXIF ‰∏≠Êúâ Model ‰ø°ÊÅØÔºåÂàôÊòæÁ§∫ËÆæÂ§áÂûãÂè∑
                        if (res.Model) $('#device-input').val(res.Model);
                        // Â¶ÇÊûúÊòØÂ∞èÁ±≥ÊâãÊú∫ÔºåÂàôÊòæÁ§∫ËÆæÂ§áÂûãÂè∑
                        if (res['39424'] && typeof res['39424'] == 'string') $('#device-input').val(res['39424']); // Xiaomi
                        // Â¶ÇÊûú EXIF ‰∏≠Êúâ CreateDate ‰ø°ÊÅØÔºåÂàôÊòæÁ§∫ÊãçÊëÑÊó∂Èó¥
                        if (res.CreateDate) $('#time-input').val(new Date(res.CreateDate).format('yyyy.MM.dd hh:mm:ss'));

                        // Â¶ÇÊûú EXIF ‰∏≠ÊúâÁÑ¶Ë∑ù‰ø°ÊÅØÔºåÂàôÊòæÁ§∫ÈïúÂ§¥ÁÑ¶Ë∑ù
                        if (res.FocalLength) $('#lens-input').val(`${parseInt(res.FocalLength)}mm`);
                        if (res.FocalLengthIn35mmFormat) $('#lens-input').val(`${parseInt(res.FocalLengthIn35mmFormat)}mm`);
                        // Â¶ÇÊûú EXIF ‰∏≠ÊúâÂÖâÂúà‰ø°ÊÅØÔºåÂàôÊòæÁ§∫ÈïúÂ§¥ÂÖâÂúà
                        if (res.FNumber) $('#lens-input').val(`${$('#lens-input').val()} f/${res.FNumber.toFixed(1)}`);
                        // Â¶ÇÊûú EXIF ‰∏≠ÊúâÊõùÂÖâÊó∂Èó¥‰ø°ÊÅØÔºåÂàôÊòæÁ§∫ÈïúÂ§¥ÊõùÂÖâÊó∂Èó¥
                        if (res.ExposureTime) $('#lens-input').val(`${$('#lens-input').val()} 1/${parseInt(res.ExposureTime ** -1)}`);
                        // Â¶ÇÊûú EXIF ‰∏≠Êúâ ISO ‰ø°ÊÅØÔºåÂàôÊòæÁ§∫ÈïúÂ§¥ ISO
                        if (res.ISO) $('#lens-input').val(`${$('#lens-input').val()} ISO${res.ISO}`);
                        //if (res.FocalLength && res.FNumber && res.ExposureTime && res.ISO) $('#lens-input').val(`${parseInt(res.FocalLength)}mm f/${res.FNumber.toFixed(1)} 1/${parseInt(res.ExposureTime ** -1)} ISO${res.ISO}`);
                        // Â¶ÇÊûú EXIF ‰∏≠Êúâ GPS ‰ø°ÊÅØÔºåÂàôÊòæÁ§∫ÊãçÊëÑ‰ΩçÁΩÆ
                        if (res.GPSLatitude && res.GPSLatitudeRef && res.GPSLongitude && res.GPSLongitudeRef) {
                            let latitude = res.GPSLatitude[0] + res.GPSLatitude[1] / 60 + res.GPSLatitude[2] / 3600;
                            let longitude = res.GPSLongitude[0] + res.GPSLongitude[1] / 60 + res.GPSLongitude[2] / 3600;
                            let latitudeDirection = res.GPSLatitudeRef === 'N' ? 'N' : 'S';
                            let longitudeDirection = res.GPSLongitudeRef === 'E' ? 'E' : 'W';
                            $('#location-input').val(`${latitude.toFixed(4)}¬∞${latitudeDirection} ${longitude.toFixed(4)}¬∞${longitudeDirection}`);
                        } else {
                            // Â¶ÇÊûúÊ≤°Êúâ GPS ‰ø°ÊÅØÔºåÂàôÊòæÁ§∫Êó†‰ΩçÁΩÆ‰ø°ÊÅØ
                            $('#location-input').val(getI18n('no_location_info'));
                        }

                        mdui.mutation();

                        // ÂêØÁî®ËÆæÂ§á„ÄÅÊó∂Èó¥„ÄÅÈïúÂ§¥Âíå‰ΩçÁΩÆËæìÂÖ•Ê°Ü
                        $('#device-input').prop('disabled', false);
                        $('#time-input').prop('disabled', false);
                        $('#lens-input').prop('disabled', false);
                        $('#location-input').prop('disabled', false);



                        // ‰∏∫ËæìÂÖ•Ê°ÜÊ∑ªÂä† mdui-textfield-not-empty Á±ªÔºå‰ΩøÂÖ∂ÊòæÁ§∫ label
                        $('#device-input').parent('.mdui-textfield').addClass('mdui-textfield-not-empty');
                        $('#time-input').parent('.mdui-textfield').addClass('mdui-textfield-not-empty');
                        $('#lens-input').parent('.mdui-textfield').addClass('mdui-textfield-not-empty');
                        $('#location-input').parent('.mdui-textfield').addClass('mdui-textfield-not-empty');
                    });
                    // ÈöêËóèÁÖßÁâáÈÄâÊã©Âå∫ÂüüÔºåÊòæÁ§∫ canvas Âå∫Âüü
                    console.log("drawImage(true)");
                    // ÁªòÂà∂ÂõæÁâáÂà∞ canvas
                    drawImage(true);

                    // Â¶ÇÊûúÊòØÁßªÂä®Á´Ø Safari ÊµèËßàÂô®Ôºå‰∏îÂõæÁâáÂ§ßÂ∞èË∂ÖËøá 5MBÔºåÂàôÊèêÁ§∫Êó†Ê≥ï‰øùÂ≠ò
                    if (navigator.userAgent.indexOf('Mobile') > -1 && navigator.userAgent.indexOf('Safari/') > -1 && photoFile.size > 1024 ** 2 * 5) {
                        mdui.snackbar({
                            message: getI18n('this_image_cannot_be_saved_in_safari'),
                            position: 'right-top'
                        });
                    }
                }
            }

            // ËØªÂèñÊñá‰ª∂‰∏∫ DataURL
            reader.readAsDataURL(photoFile);

            // ÂêØÁî®‰øùÂ≠òÂíåÈ¢ÑËßàÊåâÈíÆ
            document.querySelector('#save-btn').disabled = false;
            document.querySelector('#preview-btn').disabled = false;
            // ËÆæÁΩÆ‰øùÂ≠òÊåâÈíÆÊñáÂ≠ó‰∏∫‰øùÂ≠ò
            $('#save-btn').text(getI18n('save'));
        }

        function previewImage() {
            $.showOverlay();
            var imageHeight;
            var exportQuality = (Number($('#quality-slider input').val()) - 5) / 100; // ÂõæÁâáË¥®ÈáèÈôç‰Ωé5%
            photoCanvas.toBlob(canvasBlob => {
                imageHeight = `${document.body.clientWidth * .85 / photoCanvas.width * photoCanvas.height}px`;// ÂõæÁâáÈ´òÂ∫¶Âç†Â±èÂπïÂÆΩÂ∫¶ÁöÑ85%
                $.hideOverlay();
                mdui.dialog({
                    content: `<img src="${URL.createObjectURL(canvasBlob)}" width="100%" height="${imageHeight}" />`,
                    cssClass: 'preview-dialog',
                    buttons: [
                        {
                            text: getI18n('cancel')
                        },
                        {
                            text: getI18n('save'),
                            onClick: () => {
                                saveImage();
                            }
                        }
                    ]
                });
            }, 'image/jpg', exportQuality);
        }

        function saveImage() {
            // ËÆæÁΩÆ‰øùÂ≠òÊåâÈíÆÊñáÂ≠ó‰∏∫‚Äú‰øùÂ≠ò‰∏≠...‚Äù
            $('#save-btn').text(getI18n('saving'));
            // Á¶ÅÁî®‰øùÂ≠òÊåâÈíÆÔºåÈò≤Ê≠¢ÈáçÂ§çÁÇπÂáª
            document.querySelector('#save-btn').disabled = true;
            // Ëé∑ÂèñÂõæÁâáË¥®ÈáèÔºåÂπ∂Èôç‰Ωé5%
            var exportQuality = (Number($('#quality-slider input').val()) - 5) / 100;
            // Â∞Ü canvas ËΩ¨Êç¢‰∏∫ blob ÂØπË±°
            photoCanvas.toBlob(canvasBlob => {
                // ÂàõÂª∫‰∏Ä‰∏™ a Ê†áÁ≠æÔºåÁî®‰∫é‰∏ãËΩΩÂõæÁâá
                var imageLink = document.createElement('a');
                // ËÆæÁΩÆ‰∏ãËΩΩÁöÑÊñá‰ª∂Âêç
                imageLink.download = `watermark_${new Date().format('yyyyMMddhhmmss')}.jpg`;
                // ËÆæÁΩÆ‰∏ãËΩΩÈìæÊé•
                imageLink.href = URL.createObjectURL(canvasBlob);
                // Ê®°ÊãüÁÇπÂáª a Ê†áÁ≠æÔºåÂºÄÂßã‰∏ãËΩΩ
                imageLink.click();
                // ‰∏ãËΩΩÂÆåÊàêÂêéÔºåËÆæÁΩÆ‰øùÂ≠òÊåâÈíÆÊñáÂ≠ó‰∏∫‚Äú‰øùÂ≠ò‚Äù
                $('#save-btn').text(getI18n('save'));
                // ÂêØÁî®‰øùÂ≠òÊåâÈíÆ
                document.querySelector('#save-btn').disabled = false;
            }, 'image/jpeg', exportQuality);
        }

        function getLocation() {
            mdui.snackbar({
                message: getI18n('getting_location'),
                position: 'right-top',
                timeout: 1000
            });
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(position => {
                    mdui.snackbar({
                        message: getI18n('getting_location_success'),
                        position: 'right-top',
                        timeout: 1000
                    });
                    let latitude = position.coords.latitude;
                    let longitude = position.coords.longitude;
                    let latitudeDirection = latitude >= 0 ? 'N' : 'S';
                    let longitudeDirection = longitude >= 0 ? 'E' : 'W';
                    $('#location-input').val(`${Math.abs(latitude)}¬∞${latitudeDirection} ${Math.abs(longitude)}¬∞${longitudeDirection}`);
                    $('#location-input').parent('.mdui-textfield').addClass('mdui-textfield-not-empty');
                    drawImage(true);
                }, () => {
                    $('#location-input').val('64.9631¬∞N -19.0208¬∞W');
                    $('#location-input').parent('.mdui-textfield').addClass('mdui-textfield-not-empty');
                    mdui.snackbar({
                        message: getI18n('location_is_iceland'),
                        position: 'right-top'
                    });
                    drawImage(true);
                    mdui.snackbar({
                        message: getI18n('cant_get_your_location'),
                        position: 'right-top'
                    });
                });
            } else {
                mdui.snackbar({
                    messsge: getI18n('geolocation_is_not_supported_by_this_browser'),
                    position: 'right-top'
                });
            }
        }

        function matchModel() {
            if (photoExif.Make && photoExif.Model) {
                mdui.snackbar({
                    message: getI18n('matching'),
                    position: 'right-top'
                });
                $.ajax({
                    url: './model.json',
                    dataType: 'json',
                    success: res => {
                        if (res[photoExif.Make] && res[photoExif.Make][photoExif.Model]) {
                            $('#device-input').val(res[photoExif.Make][photoExif.Model]);
                            drawImage(true);
                        } else {
                            mdui.snackbar({
                                message: getI18n('model_not_found'),
                                position: 'right-top'
                            });
                        }
                    },
                    error: () => {
                        mdui.snackbar({
                            message: getI18n('cannot_get_model_list'),
                            position: 'right-top'
                        });
                    }
                });
            } else {
                mdui.snackbar({
                    message: getI18n('cannot_match_unknown_model'),
                    position: 'right-top'
                });
            }
        }

        function drawImage(preview) {
            // Â¶ÇÊûú preview Êú™ÂÆö‰πâÔºåÂàôËÆæÁΩÆ‰∏∫ false
            if (typeof preview == 'undefined') preview = false;
            // ÂàõÂª∫ FileReader ÂØπË±°
            var reader = new FileReader();
            // ÂΩì FileReader ËØªÂèñÊñá‰ª∂ÂÆåÊàêÊó∂
            reader.onload = (e) => {
                // ÂàõÂª∫ Image ÂØπË±°
                var photoImage = new Image();
                // ËÆæÁΩÆ Image ÂØπË±°ÁöÑ src Â±ûÊÄß‰∏∫ËØªÂèñÁöÑÊñá‰ª∂ÂÜÖÂÆπ
                photoImage.src = e.target.result;
                // ÂΩì Image ÂØπË±°Âä†ËΩΩÂÆåÊàêÊó∂
                photoImage.onload = () => {
                    // Ëé∑ÂèñÂõæÁâáÂÆΩÂ∫¶
                    var photoWidth = photoImage.width;
                    // Ëé∑ÂèñÂõæÁâáÈ´òÂ∫¶
                    var photoHeight = photoImage.height;

                    // Â¶ÇÊûúÁº©ÊîæÈÄâÊã©‰∏∫ 2ÔºåÂàôÂ∞ÜÂõæÁâáÂÆΩÈ´òÈÉΩ‰πò‰ª• 2
                    var zoom = parseInt($('#zoom-select').val());
                    if (zoom != 1) {
                        photoWidth = photoWidth * zoom;
                        photoHeight = photoHeight * zoom;
                    }

                    // ËÆæÁΩÆ canvas ÂÆΩÂ∫¶
                    photoCanvas.width = photoWidth;
                    // ËÆæÁΩÆ canvas È´òÂ∫¶ÔºåÂ¢ûÂä† 614 Áî®‰∫éÊòæÁ§∫ÊñáÂ≠ó‰ø°ÊÅØ
                    photoCanvas.height = photoHeight + 614;

                    // ËÆæÁΩÆ canvas ËÉåÊôØËâ≤‰∏∫ÁôΩËâ≤
                    photoCtx.fillStyle = 'white';
                    // Â°´ÂÖÖ canvas ËÉåÊôØ
                    photoCtx.fillRect(0, 0, photoCanvas.width, photoCanvas.height);
                    // Â∞ÜÂõæÁâáÁªòÂà∂Âà∞ canvas ‰∏ä
                    photoCtx.drawImage(photoImage, 0, 0, photoWidth, photoHeight);

                    // ËÆæÁΩÆÂ≠ó‰ΩìÊ†∑Âºè
                    photoCtx.font = `bold 120px ${fontList[parseInt($('#font-select').val())]}`;
                    // ËÆæÁΩÆÂ≠ó‰ΩìÈ¢úËâ≤‰∏∫ÈªëËâ≤
                    photoCtx.fillStyle = 'black';

                    // Ëé∑ÂèñÈïúÂ§¥‰ø°ÊÅØÊñáÊú¨ÁöÑÂÆΩÂ∫¶
                    var specLength = photoCtx.measureText($('#lens-input').val()).width;

                    // Âú® canvas ‰∏äÁªòÂà∂Áõ∏Êú∫ÂêçÁß∞‰ø°ÊÅØÔºå200ÊòØÂ∑¶ËæπË∑ù
                    photoCtx.fillText($('#device-input').val(), 200, photoHeight + 282);
                    // Âú® canvas ‰∏äÁªòÂà∂ÈïúÂ§¥‰ø°ÊÅØÔºå200ÊòØÂè≥ËæπË∑ù
                    photoCtx.fillText($('#lens-input').val(), photoWidth - specLength - 200, photoHeight + 282);


                    // ËÆæÁΩÆÂ≠ó‰ΩìÊ†∑Âºè
                    photoCtx.font = `normal 82px ${fontList[parseInt($('#font-select').val())]}`;
                    // ËÆæÁΩÆ canvas Â≠óÁ¨¶Èó¥Ë∑ù
                    photoCanvas.style.letterSpacing = '1px';
                    // ËÆæÁΩÆÂ≠ó‰ΩìÈ¢úËâ≤
                    photoCtx.fillStyle = '#727272';
                    // Âú® canvas ‰∏äÁªòÂà∂Êó∂Èó¥‰ø°ÊÅØ
                    photoCtx.fillText($('#time-input').val(), 200, photoHeight + 434);
                    // Âú® canvas ‰∏äÁªòÂà∂‰ΩçÁΩÆ‰ø°ÊÅØ
                    photoCtx.fillText($('#location-input').val(), photoWidth - specLength - 200, photoHeight + 434);

                    // Â¶ÇÊûúÈÄâÊã©‰∫Ü logo
                    if ($('#logo-select').val() != 'none') {
                        // ÂàõÂª∫ logo Image ÂØπË±°
                        var logoImage = new Image();
                        // ËÆæÁΩÆ logo Image ÂØπË±°ÁöÑ src Â±ûÊÄß
                        logoImage.src = logoList[$('#logo-select').val()];

                        // ÂΩì logo Image ÂØπË±°Âä†ËΩΩÂÆåÊàêÊó∂
                        logoImage.onload = () => {
                            var logoHeight = 250;
                            var pianyi = 30;
                            if ($('#logo-select').val() == 'sony' || $('#logo-select').val() == 'canon') {
                                pianyi = 200;
                            }
                            // Â∞Ü logo ÁªòÂà∂Âà∞ canvas ‰∏ä
                            photoCtx.drawImage(logoImage, photoWidth - specLength - 600 - pianyi, photoHeight + 180 - (pianyi / 2), logoHeight + pianyi, logoHeight + pianyi);

                            // ÁªòÂà∂ logo ÂàÜÂâ≤Á∫ø
                            photoCtx.moveTo(photoWidth - specLength - 280, photoHeight + 190);
                            photoCtx.lineTo(photoWidth - specLength - 280, photoHeight + 190 + logoHeight);
                            photoCtx.lineWidth = 10;
                            photoCtx.strokeStyle = '#cccccc';
                            photoCtx.stroke();

                            // Â¶ÇÊûúÊòØÈ¢ÑËßàÊ®°Âºè
                            if (preview) {
                                // Ëé∑ÂèñÂõæÁâáË¥®Èáè
                                var exportQuality = (Number($('#quality-slider input').val()) - 5) / 100; // ÂõæÁâáË¥®ÈáèÈôç‰Ωé5%
                                var previewQuality = exportQuality / 5;
                                // Â∞Ü canvas ËΩ¨Êç¢‰∏∫ blob ÂØπË±°
                                photoCanvas.toBlob(canvasBlob => {
                                    // ËÆæÁΩÆ #photo-canvas-div ÁöÑÊ†∑Âºè
                                    $('#photo-canvas-div').css({
                                        'display': 'flex',
                                        'justify-content': 'center',
                                        'align-items': 'center'
                                    });

                                    if (photoCanvas.height > photoCanvas.width) {
                                        $('#photo-canvas-div').css({
                                            'width': 'auto',
                                            'height': '700px'
                                        });

                                        $('#photo-preview').attr('width', 'auto'); // ÂõæÁâáÂÆΩÂ∫¶Âç†Êª°ÂÆπÂô®
                                        $('#photo-preview').attr('height', '100%'); // ÂõæÁâáÈ´òÂ∫¶Ëá™Âä®Ë∞ÉÊï¥
                                    } else {
                                        $('#photo-canvas-div').css({
                                            'width': '800px',
                                            'height': 'auto'
                                        });
                                        $('#photo-preview').attr('width', '800px'); // ÂõæÁâáÂÆΩÂ∫¶Ëá™Âä®Ë∞ÉÊï¥
                                        $('#photo-preview').attr('height', 'auto'); // ÂõæÁâáÈ´òÂ∫¶Âç†Êª°ÂÆπÂô®
                                    }

                                    // ËÆæÁΩÆÈ¢ÑËßàÂõæÁöÑ src Â±ûÊÄß
                                    $('#photo-preview').attr('src', URL.createObjectURL(canvasBlob) + '?' + new Date().getTime());
                                    $('#photo-area').addClass('mdui-hidden');
                                    $('#photo-container').removeClass('mdui-hidden');
                                    $('#photo-canvas-div').removeClass('mdui-hidden');
                                }, 'image/jpeg', previewQuality);
                            } else {
                                // ‰øùÂ≠òÂõæÁâá
                                saveImage();
                            }
                        }
                    } else {
                        // Â¶ÇÊûúÊ≤°ÊúâÈÄâÊã© logo
                        if (preview) {
                            // Ëé∑ÂèñÂõæÁâáË¥®Èáè
                            var exportQuality = (Number($('#quality-slider input').val()) - 5) / 100; // ÂõæÁâáË¥®ÈáèÈôç‰Ωé5%
                            var previewQuality = exportQuality / 5;
                            // Â∞Ü canvas ËΩ¨Êç¢‰∏∫ blob ÂØπË±°
                            photoCanvas.toBlob(canvasBlob => {

                                // ËÆæÁΩÆ #photo-canvas-div ÁöÑÊ†∑Âºè
                                $('#photo-canvas-div').css({
                                    'display': 'flex',
                                    'justify-content': 'center',
                                    'align-items': 'center'
                                });

                                if (photoCanvas.height > photoCanvas.width) {
                                    $('#photo-canvas-div').css({
                                        'width': 'auto',
                                        'height': '700px'
                                    });

                                    $('#photo-preview').attr('width', 'auto'); // ÂõæÁâáÂÆΩÂ∫¶Âç†Êª°ÂÆπÂô®
                                    $('#photo-preview').attr('height', '100%'); // ÂõæÁâáÈ´òÂ∫¶Ëá™Âä®Ë∞ÉÊï¥
                                } else {
                                    $('#photo-canvas-div').css({
                                        'width': '800px',
                                        'height': 'auto'
                                    });
                                    $('#photo-preview').attr('width', '800px'); // ÂõæÁâáÂÆΩÂ∫¶Ëá™Âä®Ë∞ÉÊï¥
                                    $('#photo-preview').attr('height', 'auto'); // ÂõæÁâáÈ´òÂ∫¶Âç†Êª°ÂÆπÂô®
                                }

                                // ËÆæÁΩÆÈ¢ÑËßàÂõæÁöÑ src Â±ûÊÄß
                                $('#photo-preview').attr('src', URL.createObjectURL(canvasBlob));
                                console.log("canvasBlob", canvasBlob);
                                $('#photo-area').addClass('mdui-hidden');
                                $('#photo-container').removeClass('mdui-hidden');
                                $('#photo-canvas-div').removeClass('mdui-hidden');
                                console.log("previewQuality", previewQuality);
                            }, 'image/jpeg', previewQuality);
                        } else {
                            // ‰øùÂ≠òÂõæÁâá
                            saveImage();
                        }
                    }
                }
            };

            // ËØªÂèñÂõæÁâáÊñá‰ª∂
            reader.readAsDataURL(photoFile);
        }



        function showModelEditor() {
            if ($('#device-input').val() == 'Unknown') {
                var deviceMake = photoExif.Make || '';
                mdui.dialog({
                    title: getI18n('model_editor'),
                    content: `<div class="mdui-textfield mdui-textfield-floating-label"><label class="mdui-textfield-label">${getI18n('camera_manufactor')}</label><input id="editor-make" class="mdui-textfield-input" type="text" value="${deviceMake}" /></div><div class="mdui-textfield mdui-textfield-floating-label"><label class="mdui-textfield-label">${getI18n('camera_model')}</label><input id="editor-model" class="mdui-textfield-input" type="text" /></div>`,
                    buttons: [
                        {
                            text: getI18n('cancel')
                        },
                        {
                            text: getI18n('ok'),
                            close: false,
                            onClick: () => {
                                if ($('#editor-make').val() != '' && $('#editor-model').val() != '') {
                                    photoExif.Make = $('#editor-make').val();
                                    photoExif.Model = $('#editor-model').val();
                                    $('#device-input').val(photoExif.Model);
                                    drawImage(true);
                                    history.back();
                                } else {
                                    mdui.snackbar({
                                        message: getI18n('please_fill_in_each_blank'),
                                        position: 'right-top'
                                    });
                                }
                            }
                        }
                    ]
                });
            } else {
                mdui.snackbar({
                    message: getI18n('you_can_only_edit_unknown_model'),
                    position: 'right-top'
                });
            }
        }

        function getFAQ() {
            var faqContent;
            $.ajax({
                url: `./faq_${langType}.html`,
                async: false,
                success: res => {
                    faqContent = res;
                },
                error: () => {
                    $.ajax({
                        url: './faq_en-us.html',
                        async: false,
                        success: res => {
                            faqContent = res;
                        }
                    });
                    mdui.snackbar({
                        message: getI18n('failed_to_load_faq_content'),
                        position: 'right-top'
                    });
                }
            });

            mdui.dialog({
                title: getI18n('faq'),
                content: faqContent,
                buttons: [
                    {
                        text: getI18n('ok')
                    }
                ]
            });
        }

        function getContributors() {
            $.showOverlay();
            $.ajax({
                url: 'https://api.github.com/repos/LTDSA/Photomark/contributors',
                dataType: 'json',
                complete: () => {
                    $.hideOverlay();
                },
                success: res => {
                    var listLayout = '';
                    res.forEach(i => {
                        listLayout += `<div class="mdui-list-item"><div class="mdui-list-item-avatar"><img src="${i.avatar_url}"/></div><div class="mdui-list-item-content"><div class="mdui-list-item-title">${i.login}</div><div class="mdui-list-item-text">${i.contributions} ${getI18n('contributions')}</div></div></div>`
                    });
                    mdui.dialog({
                        title: getI18n('contributors'),
                        content: `<div class="mdui-list">${listLayout}</div>`,
                        buttons: [
                            {
                                text: getI18n('ok')
                            }
                        ]
                    });
                },
                error: () => {
                    mdui.snackbar({
                        message: 'Cannot load contributors',
                        position: 'right-top'
                    });
                }
            });
        }

        $('#photo-area').on('dragover', function (e) {
            e.preventDefault();
            e.stopPropagation();

            if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
                $('#photo-area').addClass('mdui-color-grey-800');
                $('#photo-area').removeClass('mdui-color-grey-700');
            } else {
                $('#photo-area').addClass('mdui-color-grey-300');
                $('#photo-area').removeClass('mdui-color-grey-200');
            }
        });

        $('#photo-area').on('drop', function (e) {
            e.preventDefault();
            e.stopPropagation();

            if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
                $('#photo-area').removeClass('mdui-color-grey-800');
                $('#photo-area').addClass('mdui-color-grey-700');
            } else {
                $('#photo-area').removeClass('mdui-color-grey-300');
                $('#photo-area').addClass('mdui-color-grey-200');
            }

            console.log(e);

            readImage(e.dataTransfer.files[0]);
        });

        $('#photo-preview').on('dragover', function (e) {
            e.preventDefault();
            e.stopPropagation();
        });

        $('#photo-canvas-div').on('drop', function (e) {
            e.preventDefault();
            e.stopPropagation();

            console.log(e);

            readImage(e.dataTransfer.files[0]);
        });

        $('#font-select').on('change', () => {
            $('body').removeClass('harmony-sans');
            $('body').removeClass('oppo-sans');
            $('body').removeClass('sf-pro');
            switch (parseInt($('#font-select').val())) {
                case 1:
                    //$('body').removeClass('harmony-sans');
                    break;
                case 2:
                    $('body').addClass('harmony-sans');
                    break;
                case 3:
                    $('body').addClass('oppo-sans');
                    break;
                case 4:
                    $('body').addClass('sf-pro');
                    break;
            }

            mdui.snackbar({
                message: getI18n('changing_font_please_wait'),
                position: 'right-top'
            });

            drawImage(true);
        });

        $('#logo-select').on('change', () => {
            drawImage(true);
        });

        $('#zoom-select').on('change', () => {
            drawImage(true);
        });

        $('#quality-slider input').on('input', function () {
            let value = $(this).val();
            let displayText = value === "100" ? "ÂéüÂõæ" : value + "%";
            $('#quality-value').text(displayText);
            drawImage(true);

        });

        var isDarkMode = false; // ÂàùÂßã‰∏∫ÊµÖËâ≤Ê®°Âºè
        var currentHour = new Date().getHours();
        if (currentHour < 8 || currentHour >= 22) {
            isDarkMode = true;
            $('body').addClass('mdui-theme-layout-dark');
            $('#photo-area').removeClass('mdui-color-grey-200');
            $('#photo-area').addClass('mdui-color-grey-700');
            $('#theme-toggle i').text('brightness_7'); // ÂàáÊç¢‰∏∫Ê∑±Ëâ≤Ê®°ÂºèÂõæÊ†á
        }

        $('#theme-toggle').on('click', function () {
            $('body').addClass('mdui-theme-transition');
            $('#photo-area').addClass('mdui-theme-transition');
            setTimeout(() => {
                $('body').removeClass('mdui-theme-transition');
                $('#photo-area').removeClass('mdui-theme-transition');
            }, 300);
            if (isDarkMode) {
                $('body').removeClass('mdui-theme-layout-dark');
                $('#photo-area').removeClass('mdui-color-grey-700');
                $('#photo-area').addClass('mdui-color-grey-200');
                $('#theme-toggle i').text('brightness_4'); // ÂàáÊç¢‰∏∫ÊµÖËâ≤Ê®°ÂºèÂõæÊ†á
            } else {
                $('body').addClass('mdui-theme-layout-dark');
                $('#photo-area').removeClass('mdui-color-grey-200');
                $('#photo-area').addClass('mdui-color-grey-700');
                $('#theme-toggle i').text('brightness_7'); // ÂàáÊç¢‰∏∫Ê∑±Ëâ≤Ê®°ÂºèÂõæÊ†á
            }
            isDarkMode = !isDarkMode;
        });

        $('#device-input').on('input', function () {
            drawImage(true);
        });

        $('#time-input').on('input', function () {
            drawImage(true);
        });

        $('#lens-input').on('input', function () {
            drawImage(true);
        });

        $('#location-input').on('input', function () {
            drawImage(true);
        });
    </script>
</body>

</html>